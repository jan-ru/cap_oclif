version: '3.8'

services:
  # Keycloak Authentication Server
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: financial-reports-keycloak
    environment:
      # Admin credentials
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      
      # Database configuration (using H2 for development)
      KC_DB: dev-file
      
      # HTTP configuration
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: 8080
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      
      # Logging
      KC_LOG_LEVEL: INFO
    
    command:
      - start-dev
      - --import-realm
    
    ports:
      - "8080:8080"
    
    volumes:
      # Mount realm configuration for auto-import
      - ./docker/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - keycloak-data:/opt/keycloak/data
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    networks:
      - financial-reports-network

  # Financial Reports API
  financial-reports-api:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: financial-reports-api
    
    environment:
      # Application mode
      APP_MODE: api
      NODE_ENV: production
      
      # Server configuration
      PORT: 3000
      HOST: 0.0.0.0
      
      # Keycloak Authentication Configuration
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: financial-reports
      JWT_ISSUER: http://keycloak:8080/realms/financial-reports
      JWT_AUDIENCE: financial-reports-api
      JWT_ALGORITHMS: RS256
      JWT_CLOCK_TOLERANCE: 30
      
      # JWKS Configuration
      JWKS_CACHE_TIMEOUT: 3600000
      JWKS_RATE_LIMIT: 10
      JWKS_REQUESTS_PER_MINUTE: 5
      
      # Rate Limiting
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX_REQUESTS: 100
      
      # Security
      REQUIRE_HTTPS: "false"  # Set to true in production with proper TLS
      
      # CORS Configuration
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:8080
      
      # Logging
      LOG_LEVEL: info
      AUDIT_ENABLED: "true"
      INCLUDE_TOKEN_CLAIMS: "false"
      
      # OData Service Configuration (update with your service URL)
      ODATA_SERVICE_URL: ${ODATA_SERVICE_URL:-http://odata-service:4004/odata/v4/financial}
    
    ports:
      - "3000:3000"
    
    depends_on:
      keycloak:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - financial-reports-network
    
    restart: unless-stopped

  # Optional: PostgreSQL for Keycloak (production setup)
  # Uncomment this section for production deployment
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: financial-reports-postgres
  #   environment:
  #     POSTGRES_DB: keycloak
  #     POSTGRES_USER: keycloak
  #     POSTGRES_PASSWORD: keycloak_password
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - financial-reports-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U keycloak"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  keycloak-data:
    driver: local
  # postgres-data:
  #   driver: local

networks:
  financial-reports-network:
    driver: bridge
